
<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apptainer/Singularity &mdash; Sheffield HPC Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=0a35405e" />

  
    <link rel="canonical" href="https://docs.hpc.shef.ac.uk/stanage/software/apps/apptainer.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=f281be69"></script>
        <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="CASTEP" href="castep.html" />
    <link rel="prev" title="ANSYSEM" href="ansysem.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Sheffield HPC Documentation
              <img src="../../../_static/UOSLogo_Primary_Violet_RGB_small.png" class="logo" alt="Logo"/>
          </a><div>
    <h3>Quick search</h3>
    <!--Setup by JKWM via https://cse.google.com/cse/all-->
    <script async src="https://cse.google.com/cse.js?cx=243e6cd4be08b404b">
    </script>
    <div class="gcse-search"></div>
 </div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../hpc/index.html">Using the HPC Systems</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Stanage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../stanage-FAQ-gotchas.html">Stanage FAQ and Gotchas</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Software on Stanage</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Applications on Stanage</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="ansys/index.html">ANSYS</a></li>
<li class="toctree-l4"><a class="reference internal" href="R.html">R</a></li>
<li class="toctree-l4"><a class="reference internal" href="abaqus.html">Abaqus</a></li>
<li class="toctree-l4"><a class="reference internal" href="ansysem.html">ANSYSEM</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Apptainer/Singularity</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#about-apptainer-containers-and-images">About Apptainer Containers and Images</a></li>
<li class="toctree-l5"><a class="reference internal" href="#apptainer-versus-singularity">Apptainer versus Singularity</a></li>
<li class="toctree-l5"><a class="reference internal" href="#interactive-usage-of-apptainer-images">Interactive Usage of Apptainer Images</a></li>
<li class="toctree-l5"><a class="reference internal" href="#submitting-batch-jobs-that-uses-apptainer-images">Submitting Batch Jobs That Uses Apptainer Images</a></li>
<li class="toctree-l5"><a class="reference internal" href="#using-nvidia-gpus-with-apptainer-images">Using Nvidia GPUs with Apptainer Images</a></li>
<li class="toctree-l5"><a class="reference internal" href="#automatic-mounting-of-stanage-filestore-inside-images">Automatic Mounting of Stanage Filestore Inside Images</a></li>
<li class="toctree-l5"><a class="reference internal" href="#image-index-on-github">Image Index on Github</a></li>
<li class="toctree-l5"><a class="reference internal" href="#installing-apptainer-on-your-local-machine">Installing Apptainer on Your Local Machine</a></li>
<li class="toctree-l5"><a class="reference internal" href="#manually-mounting-paths">Manually Mounting Paths</a></li>
<li class="toctree-l5"><a class="reference internal" href="#creating-your-own-apptainer-images">Creating Your Own Apptainer Images</a></li>
<li class="toctree-l5"><a class="reference internal" href="#how-apptainer-is-installed-and-versioned-on-the-cluster">How Apptainer is Installed and ‘versioned’ on the Cluster</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="castep.html">CASTEP</a></li>
<li class="toctree-l4"><a class="reference internal" href="git-lfs.html">Git LFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="gmp.html">GnuMP</a></li>
<li class="toctree-l4"><a class="reference internal" href="gromacs.html">GROMACS</a></li>
<li class="toctree-l4"><a class="reference internal" href="java.html">Java (Temurin/OpenJDK)</a></li>
<li class="toctree-l4"><a class="reference internal" href="julia.html">Julia</a></li>
<li class="toctree-l4"><a class="reference internal" href="lammps.html">LAMMPS</a></li>
<li class="toctree-l4"><a class="reference internal" href="mathematica.html">Mathematica</a></li>
<li class="toctree-l4"><a class="reference internal" href="matlab.html">MATLAB</a></li>
<li class="toctree-l4"><a class="reference internal" href="maven.html">Maven</a></li>
<li class="toctree-l4"><a class="reference internal" href="molpro.html">Molpro</a></li>
<li class="toctree-l4"><a class="reference internal" href="ncdu.html">ncdu</a></li>
<li class="toctree-l4"><a class="reference internal" href="netlogo.html">NetLogo</a></li>
<li class="toctree-l4"><a class="reference internal" href="nextflow.html">Nextflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="openfoam.html">OpenFOAM</a></li>
<li class="toctree-l4"><a class="reference internal" href="python.html">Python</a></li>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html">PyTorch</a></li>
<li class="toctree-l4"><a class="reference internal" href="rosetta.html">Rosetta</a></li>
<li class="toctree-l4"><a class="reference internal" href="rstudio.html">RStudio</a></li>
<li class="toctree-l4"><a class="reference internal" href="sox.html">SoX</a></li>
<li class="toctree-l4"><a class="reference internal" href="tensorflow.html">TensorFlow</a></li>
<li class="toctree-l4"><a class="reference internal" href="vasp.html">VASP</a></li>
<li class="toctree-l4"><a class="reference internal" href="xvfb.html">Xvfb</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../development/index.html">Developing on Stanage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../libs/index.html">Libraries on Stanage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../parallel/index.html">Parallel Systems on Stanage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cluster_specs.html">Stanage Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../slurm.html">Slurm Scheduler Job Submission info</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../stanage-mfa-setup.html">Stanage TOTP multifactor authentication setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../GPUComputingStanage.html">Using GPUs on Stanage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../bessemer/index.html">Bessemer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parallel/index.html">Parallel Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newsletter/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary of Terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other-uk-hpc-resources.html">Access to External UK HPC Facilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../help.html">Need help?</a></li>
<li class="toctree-l1"><a class="reference external" href="https://rcgsheffield.github.io/TUoS-RIT-training-resources/training.html">Courses / Training Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cheatsheets/index.html">Quick Reference (Cheat Sheets)</a></li>
<li class="toctree-l1"><a class="reference external" href="http://changelog.hpc.shef.ac.uk/">Latest Software / HPC changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../referenceinfo/index.html">Reference Information Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Suggested text for citations and letters of support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../decommissioned/index.html">Decommissioned Clusters</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Sheffield HPC Documentation</a>
      </nav>

      <div class="wy-nav-content">
<!-- <a class="forkme" href="https://github.com/rcgsheffield/sheffield_hpc">
<img alt="Fork me on GitHub" src="../../../_static/img/forkme.png"> 
</a> -->

        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Stanage</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Software on Stanage</a></li>
          <li class="breadcrumb-item"><a href="index.html">Applications on Stanage</a></li>
      <li class="breadcrumb-item active">Apptainer/Singularity</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="apptainer-singularity">
<span id="apptainer-stanage"></span><h1>Apptainer/Singularity<a class="headerlink" href="#apptainer-singularity" title="Link to this heading"></a></h1>
<aside class="sidebar">
<p class="sidebar-title">Apptainer</p>
<dl class="field-list simple">
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>1.1.x</p>
</dd>
<dt class="field-even">URL<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://apptainer.org/">https://apptainer.org/</a></p>
</dd>
</dl>
</aside>
<p>Designed around the notion of extreme mobility of compute and reproducible science,
Apptainer (<a class="reference internal" href="#apptainer-vs-singularity-stanage"><span class="std std-ref">previously known as Singularity</span></a>)
enables users to have full control of their operating system environment.
This means that a non-privileged user can “swap out” the operating system on the host for one they control.
So if the host system is running CentOS Linux but your application runs in Ubuntu Linux,
you can create an Ubuntu image,
install your applications into that image,
copy the image to another host,
and run your application on that host in it’s native Ubuntu environment.</p>
<p>Apptainer also allows you to leverage the resources of whatever host you are on.
This includes high-speed cluster interconnects,
resource managers,
file systems,
GPUs and/or
accelerators, etc.</p>
<section id="about-apptainer-containers-and-images">
<h2>About Apptainer Containers and Images<a class="headerlink" href="#about-apptainer-containers-and-images" title="Link to this heading"></a></h2>
<p>Similar to Docker,
an Apptainer container (image) is a self-contained software stack.
As Apptainer does not require a root-level daemon to run its images
it is compatible for use with Stanage’s scheduler inside your job scripts.
The running images also uses the credentials of the person calling it.</p>
<p>In practice, this means that an image created on your local machine
with all your research software installed for local development
will also run on the HPC cluster.</p>
<p>Pre-built images have been provided on the cluster and
can also be download for use on your local machine
(see <a class="reference internal" href="#use-image-apptainer-stanage"><span class="std std-ref">Interactive Usage of Apptainer Images</span></a>).
Creating and modifying images however,
requires root permission and so
must be done on your machine (see <a class="reference internal" href="#create-image-apptainer-stanage"><span class="std std-ref">Creating Your Own Apptainer Images</span></a>).</p>
</section>
<section id="apptainer-versus-singularity">
<span id="apptainer-vs-singularity-stanage"></span><h2>Apptainer versus Singularity<a class="headerlink" href="#apptainer-versus-singularity" title="Link to this heading"></a></h2>
<p>The Singularity project forked into the Apptainer and the Singularity CE projects in 2021.
If you’ve previously used Singularity on TUOS’s HPC systems and now want to use Apptainer
then be aware that:</p>
<ul class="simple">
<li><p>Apptainer is (currently) almost identical in behaviour and usage to the latest release of Singularity:
it understands the same image format and has very similar command-line behaviour;</p></li>
<li><p>You should run <code class="docutils literal notranslate"><span class="pre">apptainer</span></code> instead of <code class="docutils literal notranslate"><span class="pre">singularity</span></code></p></li>
<li><p>Singularity behaviour could previously be modified using environment variables with prefixes <code class="docutils literal notranslate"><span class="pre">SINGULARITY_</span></code> and <code class="docutils literal notranslate"><span class="pre">SINGULARITYENV_</span></code>;
you should now use <code class="docutils literal notranslate"><span class="pre">APPTAINER_</span></code> and <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> prefixes instead (but the old prefixes will still work for now);</p></li>
<li><p>The per-user configuration directory has changed from <code class="docutils literal notranslate"><span class="pre">~/.singularity</span></code> to <code class="docutils literal notranslate"><span class="pre">~/.apptainer</span></code>.</p></li>
<li><p>If you tried pulling images from a remote repository using Singularity without specifying the repository hostname then
this would default to pulling images from <a class="reference external" href="https://cloud.sylabs.io/">https://cloud.sylabs.io/</a>.
With Apptainer there is no default remote repository.</p></li>
</ul>
<p>For more information on the differences between Apptainer and Singularity see the <a class="reference external" href="https://github.com/apptainer/apptainer/releases/tag/v1.0.0">Apptainer 1.0.0 release notes</a>.</p>
</section>
<section id="interactive-usage-of-apptainer-images">
<span id="use-image-apptainer-stanage"></span><h2>Interactive Usage of Apptainer Images<a class="headerlink" href="#interactive-usage-of-apptainer-images" title="Link to this heading"></a></h2>
<p><strong>To use Apptainer interactively, an interactive session must first be requested using</strong> <a class="reference internal" href="../../../hpc/scheduler/index.html#submit-interactive-stanage"><span class="std std-ref">srun</span></a> <strong>for example.</strong></p>
<p>To get an interactive shell in to the image, use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">shell</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imgfile</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>Or if you prefer bash:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">exec</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imgfile</span><span class="o">.</span><span class="n">img</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">exec</span></code> command can also be used to execute other applications/scripts inside the image or
from the mounted directories (See <a class="reference internal" href="#auto-mounting-filestore-apptainer-stanage"><span class="std std-ref">Automatic Mounting of Stanage Filestore Inside Images</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">exec</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imgfile</span><span class="o">.</span><span class="n">img</span> <span class="n">my_script</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may get a warning similar to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>groups: cannot find name for group ID ...
</pre></div>
</div>
<p><a class="reference internal" href="../../../decommissioned/sharc/FAQ_sharc.html#unnamed-groups"><span class="std std-ref">This can be ignored</span></a> and will not have an affect on running the image.</p>
</div>
</section>
<section id="submitting-batch-jobs-that-uses-apptainer-images">
<span id="use-image-batch-apptainer-stanage"></span><h2>Submitting Batch Jobs That Uses Apptainer Images<a class="headerlink" href="#submitting-batch-jobs-that-uses-apptainer-images" title="Link to this heading"></a></h2>
<p>When submitting a job that uses an Apptainer image,
it is not possible to use the interactive shell
(e.g. <code class="docutils literal notranslate"><span class="pre">apptainer</span> <span class="pre">shell</span></code> or <code class="docutils literal notranslate"><span class="pre">apptainer</span> <span class="pre">exec</span> <span class="pre">path/to/imgfile.img</span> <span class="pre">/bin/bash</span></code>).
You must use the <code class="docutils literal notranslate"><span class="pre">exec</span></code> command to call the desired application or script directly.</p>
<p>For example, if we would like to use a command <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">/</span></code> to get the content of the root folder in the image,
two approaches are shown in the following job script <code class="docutils literal notranslate"><span class="pre">my_apptainer_job.sh</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --mem 8G</span>
<span class="c1"># We requested 8GB of memory in the line above, change this according to your</span>
<span class="c1"># needs e.g. add --gres=gpu:1 to request a single GPU</span>

<span class="c1"># Calling ls directly using the exec command</span>
apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>path/to/imgfile.img<span class="w"> </span>ls<span class="w"> </span>/

<span class="c1"># Have Apptainer call a custom script from your home or other mounted directories</span>
<span class="c1"># Don&#39;t forget to make the script executable before running by using chmod</span>
chmod<span class="w"> </span>+x<span class="w"> </span>~/myscript.sh
apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>path/to/imgfile.img<span class="w"> </span>~/myscript.sh
</pre></div>
</div>
<p>Where the content of <code class="docutils literal notranslate"><span class="pre">~/myscript.sh</span></code> is shown below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

ls<span class="w"> </span>/
</pre></div>
</div>
<p>The job can then be submitted as normal with <code class="docutils literal notranslate"><span class="pre">sbatch</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbatch</span> <span class="n">my_apptainer_job</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</section>
<section id="using-nvidia-gpus-with-apptainer-images">
<h2>Using Nvidia GPUs with Apptainer Images<a class="headerlink" href="#using-nvidia-gpus-with-apptainer-images" title="Link to this heading"></a></h2>
<p>You can use GPUs in your image by adding the <code class="docutils literal notranslate"><span class="pre">--nv</span></code> flag to the command e.g. for running interactively:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">shell</span> <span class="o">--</span><span class="n">nv</span> <span class="n">myimage</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
<p>or when running within the batch file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">exec</span> <span class="o">--</span><span class="n">nv</span> <span class="n">myimage</span><span class="o">.</span><span class="n">sim</span> <span class="n">myscript</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>A quick way to test that GPU is enabled in your image is by running the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span>
</pre></div>
</div>
<p>Where you will get something similar to the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Tue Mar 28 16:43:08 2017
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 367.57                 Driver Version: 367.57                    |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  GeForce GTX TITAN   Off  | 0000:01:00.0      On |                  N/A |
| 30%   35C    P8    18W / 250W |    635MiB /  6078MiB |      1%      Default |
+-------------------------------+----------------------+----------------------+
</pre></div>
</div>
</section>
<section id="automatic-mounting-of-stanage-filestore-inside-images">
<span id="auto-mounting-filestore-apptainer-stanage"></span><h2>Automatic Mounting of Stanage Filestore Inside Images<a class="headerlink" href="#automatic-mounting-of-stanage-filestore-inside-images" title="Link to this heading"></a></h2>
<p>When running Apptainer containers on the cluster,
the paths <code class="docutils literal notranslate"><span class="pre">/mnt/parscratch</span></code> <code class="docutils literal notranslate"><span class="pre">/home</span></code>, and <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> are
automatically <em>bind-mounted</em> (exposed) from the <em>host</em> operating system into your container,
i.e. the cluster’s ordinary filestores will be automatically visible within a container started on the cluster
without that directory being explicitly created when the corresponding Apptainer image was built.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The automatic bind mounting of your HPC home directory into Apptainer containers can result in the unexpected sharing of things like executables
and libraries between the host and Apptainer container.</p>
<p>Unintended behaviour may occur with Apptainer on the HPC system due to the presence of:</p>
<ul class="simple">
<li><p>Shell initialisation files e.g. <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> or <code class="docutils literal notranslate"><span class="pre">~/.profile</span></code></p></li>
<li><p>R profile files (e.g. <code class="docutils literal notranslate"><span class="pre">~/.Rprofile</span></code>) and/or libraries (e.g <code class="docutils literal notranslate"><span class="pre">~/R/x86_64-pc-linux-gnu-library/4.1</span></code>)</p></li>
<li><p>Python or Conda initilisation files, (virtual/conda) envs or packages <code class="docutils literal notranslate"><span class="pre">~/.conda/</span></code>, <code class="docutils literal notranslate"><span class="pre">~/.condarc</span></code>, <code class="docutils literal notranslate"><span class="pre">~/.local/python</span></code> etc…</p></li>
<li><p>User supplied executables or libraries e.g. <code class="docutils literal notranslate"><span class="pre">~/bin</span></code>, <code class="docutils literal notranslate"><span class="pre">~/lib</span></code>, etc…</p></li>
</ul>
</div>
</section>
<section id="image-index-on-github">
<h2>Image Index on Github<a class="headerlink" href="#image-index-on-github" title="Link to this heading"></a></h2>
<p>All our Apptainer container definitions can be found at <a class="reference external" href="https://github.com/rses-singularity">https://github.com/rses-singularity</a>. The definition files can be used as a template for building your own images.</p>
</section>
<section id="installing-apptainer-on-your-local-machine">
<h2>Installing Apptainer on Your Local Machine<a class="headerlink" href="#installing-apptainer-on-your-local-machine" title="Link to this heading"></a></h2>
<p>You will need Apptainer installed on your machine in order to locally run, create and modify images.
See the <a class="reference external" href="https://github.com/apptainer/apptainer/blob/main/INSTALL.md">Apptainer project’s installation instructions</a>.</p>
</section>
<section id="manually-mounting-paths">
<h2>Manually Mounting Paths<a class="headerlink" href="#manually-mounting-paths" title="Link to this heading"></a></h2>
<p>When using Stanage’s pre-built images on your local machine,
it may be useful to mount the existing directories in the image to your own path.
This can be done with the flag <code class="docutils literal notranslate"><span class="pre">-B</span> <span class="pre">local/path:image/path</span></code> with
the path outside of the image left of the colon and
the path in the image on the right side, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">shell</span> <span class="o">-</span><span class="n">B</span> <span class="n">local</span><span class="o">/</span><span class="n">datapath</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="p">,</span><span class="n">local</span><span class="o">/</span><span class="n">anotherpath3</span><span class="p">:</span><span class="o">/</span><span class="n">anotherpath3</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imgfile</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>The command mounts the path <code class="docutils literal notranslate"><span class="pre">local/datapath</span></code> on your local machine to
the <code class="docutils literal notranslate"><span class="pre">/data</span></code> path in the image.
Multiple mount points can be joined with <code class="docutils literal notranslate"><span class="pre">,</span></code>
as shown above where we additionally specify that <code class="docutils literal notranslate"><span class="pre">local/anotherpath3</span></code> mounts to <code class="docutils literal notranslate"><span class="pre">/anotherpath3</span></code>.
The <code class="docutils literal notranslate"><span class="pre">/home</span></code> folder is automatically mounted by default.</p>
<p><strong>Note: In order to mount a path, the directory must already exist within the image.</strong></p>
</section>
<section id="creating-your-own-apptainer-images">
<span id="create-image-apptainer-stanage"></span><h2>Creating Your Own Apptainer Images<a class="headerlink" href="#creating-your-own-apptainer-images" title="Link to this heading"></a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Root access is required for modifying Apptainer images so if you need to edit an
image it must be done on your local machine.  However you can create disk
images and import Docker images using normal user privileges on recent
versions of Apptainer.</p>
</div>
<p>First create an Apptainer definition file for bootstrapping an image your image. An example definition file we’ll name <code class="docutils literal notranslate"><span class="pre">apptainer-test.def</span></code> is shown below</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Bootstrap</span><span class="p">:</span> <span class="n">docker</span>
<span class="n">From</span><span class="p">:</span> <span class="n">ubuntu</span><span class="p">:</span><span class="n">latest</span>

<span class="o">%</span><span class="n">setup</span>
  <span class="c1"># Runs on host. The path to the image is $APPTAINER_ROOTFS</span>

<span class="o">%</span><span class="n">post</span>
  <span class="c1">#Post setup, runs inside the image</span>

  <span class="c1"># Default mount paths</span>
  <span class="n">mkdir</span> <span class="o">/</span><span class="n">scratch</span> <span class="o">/</span><span class="n">data</span> <span class="o">/</span><span class="n">shared</span> <span class="o">/</span><span class="n">fastdata</span>

  <span class="c1"># Install the packages you need</span>
  <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">git</span> <span class="n">vim</span> <span class="n">cmake</span>


<span class="o">%</span><span class="n">runscript</span>
  <span class="c1"># Runs inside the image every time it starts up</span>

<span class="o">%</span><span class="n">test</span>
  <span class="c1"># Test script to verify that the image is built and running correctly</span>
</pre></div>
</div>
<p>The definition file takes a base image from <a class="reference external" href="https://hub.docker.com/">DockerHub</a>,
in this case the latest version of Ubuntu <code class="docutils literal notranslate"><span class="pre">ubuntu:latest</span></code>.
Other images on the hub can also be used as the base for the Apptainer image,
e.g. <code class="docutils literal notranslate"><span class="pre">From:</span> <span class="pre">nvidia/cuda:8.0-cudnn5-devel-ubuntu16.04</span></code> uses Nvidia’s docker image with Ubuntu 16.04 that already has CUDA 8 installed.</p>
<p>After creating a definition file, use the <code class="docutils literal notranslate"><span class="pre">build</span></code> command to build the image from your definition file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apptainer</span> <span class="n">build</span> <span class="n">apptainer</span><span class="o">-</span><span class="n">test</span><span class="o">.</span><span class="n">sif</span> <span class="n">apptainer</span><span class="o">-</span><span class="n">test</span><span class="o">.</span><span class="k">def</span>
</pre></div>
</div>
<p>It is also possible to build Apptainer images directory directly from images on <a class="reference external" href="https://hub.docker.com/">DockerHub</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apptainer</span> <span class="n">build</span> <span class="n">myimage</span><span class="o">.</span><span class="n">sif</span> <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">ubuntu</span><span class="p">:</span><span class="n">latest</span>
</pre></div>
</div>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">build</span></code> command creates a read-only squashfs file. It is possible to add the <code class="docutils literal notranslate"><span class="pre">--writable</span></code> or <code class="docutils literal notranslate"><span class="pre">--sandbox</span></code> flag to the build command in order to create a writable ext image or a writable sandbox directory respectively.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apptainer</span> <span class="n">build</span> <span class="o">--</span><span class="n">sandbox</span> <span class="n">myimage_folder</span> <span class="n">Apptainer</span>
</pre></div>
</div>
<p>You will also need to add the <code class="docutils literal notranslate"><span class="pre">--writable</span></code> flag to the command when going in to change the contents of an image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apptainer</span> <span class="n">shell</span> <span class="o">--</span><span class="n">writable</span> <span class="n">myimage_folder</span>
</pre></div>
</div>
</section>
<section id="how-apptainer-is-installed-and-versioned-on-the-cluster">
<h2>How Apptainer is Installed and ‘versioned’ on the Cluster<a class="headerlink" href="#how-apptainer-is-installed-and-versioned-on-the-cluster" title="Link to this heading"></a></h2>
<p>Apptainer, unlike much of the other key software packages on Stanage,
is not activated using module files.
This is because module files are primarily for the purpose of
being able to install multiple version of the same software
and for security reasons only the most recent version of Apptainer is installed.
The security risks associated with providing outdated builds of Apptainer
are considered to outweigh the risk of upgrading to backwards incompatible versions.</p>
<p>Apptainer has been installed on all worker and login nodes.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ansysem.html" class="btn btn-neutral float-left" title="ANSYSEM" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="castep.html" class="btn btn-neutral float-right" title="CASTEP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, The University of Sheffield.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<footer class="footer">
  <div class="container">
    <div class="left-footer">
         &copy; 2024, The University of Sheffield
       <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>
    </div>
   
    <div class="centre-footer">
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7
    </div>
  </div>
</footer>

</body>
</html>